# worker_processes auto: Nginx spawns ~1 worker per CPU core. Each worker runs an event loop.
# worker_connections 1024: max concurrent connections per worker (not requests). Real cap ≈ workers × 1024 (also bounded by OS limits like ulimit -n).
worker_processes auto;
events { worker_connections 1024; }

## access log format
# log_format = defines how each request will be logged
# main = the name of this logging format

# $remote_addr          → client IP
# $time_local           → timestamp of request
# $request              → HTTP method + path (e.g. GET /api/users)
# $status               → HTTP status code (200, 404, 500 etc)
# $body_bytes_sent      → bytes sent in response body
# $http_referer         → page user came from (if any)
# $http_user_agent      → browser or tool making the request
# $http_x_forwarded_for → real client IP from proxy chain
# rid=$reqid            → request ID for tracing request across services

# map block = creates our own variable $reqid from $request_id
# (future-proof; allows customizing logic later)
# map $request_id $reqid { 
#   default $request_id; 
# }
# access_log = tells nginx to write logs to this file
# /var/log/nginx/access.log = file path inside container
# main = use the format defined above
# access_log /var/log/nginx/access.log main;

http {
  log_format json escape=json
    '{'
      '"time":"$time_local",'
      '"ip":"$remote_addr",'
      '"method":"$request_method",'
      '"uri":"$request_uri",'
      '"status":$status,'
      '"bytes":$body_bytes_sent,'
      '"referer":"$http_referer",'
      '"user_agent":"$http_user_agent",'
      '"xff":"$proxy_add_x_forwarded_for",'
      '"scheme":"$scheme",'
      '"host":"$host",'
      '"req_id":"$reqid"'
    '}';

  ##Map built-in request_id → $reqid (short variable to use in logs)
  ##
  map $request_id $reqid { 
    default $request_id; 
  }

  ## Write logs to mounted volume file in JSON format
  access_log /var/log/nginx/access_app.log json;


# Defines named pools. By default Nginx does round-robin across listed servers.
# frontend1, frontend2, backend1, backend2 resolve via Docker’s DNS on your user-defined network.
# You can later add methods: least_conn;, ip_hash;, health checks, keepalive, etc.

  upstream fe {
    server frontend1:80;
    server frontend2:80;
  }

  upstream api {
    server backend1:5000;
    server backend2:5000;
  }

  server {
    # This Nginx instance listens inside the container on port 8888. Docker maps it to your host port via ports: in compose.
    listen 8888;
    
    # health for ALB
    location = /health { return 200 'ok\n'; add_header Content-Type text/plain; }   
        

    # security/minimal
    # Security + tracing headers

# X-Content-Type-Options: nosniff
# - Stops browser from guessing file types
# - Prevents MIME-type attacks (e.g., treat .js as .jpg to bypass security)

# X-Frame-Options: SAMEORIGIN
# - Prevents this site from being loaded in an iframe on other domains
# - Protects against clickjacking attacks

# X-Request-ID: $reqid
# - Adds a unique request ID to every request
# - Helps trace the same request across Nginx → backend logs
# - Very useful for debugging distributed systems and microservices

    add_header X-Content-Type-Options nosniff always;
    add_header X-Frame-Options SAMEORIGIN always;
    add_header X-Request-ID $reqid always;


# /api/ location block: forwards all API requests to backend services

# proxy_pass http://api;
# - Sends /api/* requests to the backend upstream group named "api"
# - The upstream servers are defined above (backend1, backend2, etc.)

# proxy_http_version 1.1;
# - Required for keep-alive and modern proxy behavior (connection reuse)

# proxy_set_header Host $host;
# - Passes the original Host header to the backend
#   so backend knows the real domain name

# proxy_set_header X-Real-IP $remote_addr;
# - Sends the user's actual IP to the backend
#   (otherwise backend only sees Nginx container IP)

# proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
# - Standard header to track chain of client IPs through proxies

# proxy_set_header X-Forwarded-Proto $scheme;
# - Tells backend whether client used http or https

# proxy_set_header X-Request-ID $reqid;
# - Unique request ID for tracing/log correlation across services

    location /api/ {
      proxy_pass http://api;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Request-ID $reqid;
    }

    location / {
      proxy_pass http://fe;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Request-ID $reqid;
    }
  }
}